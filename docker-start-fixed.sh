#!/bin/bash

# ะกะบัะธะฟั ะดะปั ะทะฐะฟััะบะฐ ะฟัะธะปะพะถะตะฝะธั ัะตัะตะท Docker ะฝะฐ VPS
echo "๐ ะะฐะฟััะบ OBSCUR Clothes ะฟัะธะปะพะถะตะฝะธั..."

# ะััะฐะฝะพะฒะบะฐ ะธ ัะดะฐะปะตะฝะธะต ััะฐััั ะบะพะฝัะตะนะฝะตัะพะฒ
echo "๐ฆ ะััะฐะฝะพะฒะบะฐ ััะฐััั ะบะพะฝัะตะนะฝะตัะพะฒ..."
docker-compose down
docker system prune -f

# ะฃะดะฐะปะตะฝะธะต package-lock.json ัะฐะนะปะพะฒ ะดะปั ะฟัะตะดะพัะฒัะฐัะตะฝะธั ะบะพะฝัะปะธะบัะพะฒ
echo "๐งน ะัะธััะบะฐ lock ัะฐะนะปะพะฒ..."
rm -f package-lock.json
rm -f client/package-lock.json

# ะกะฑะพัะบะฐ ะธ ะทะฐะฟััะบ ะฝะพะฒัั ะบะพะฝัะตะนะฝะตัะพะฒ
echo "๐จ ะกะฑะพัะบะฐ ะธ ะทะฐะฟััะบ ะฟัะธะปะพะถะตะฝะธั..."
docker-compose up --build -d

# ะะถะธะดะฐะฝะธะต ะทะฐะฟััะบะฐ
echo "โณ ะะถะธะดะฐะฝะธะต ะณะพัะพะฒะฝะพััะธ ะฟัะธะปะพะถะตะฝะธั..."
sleep 30

# ะัะพะฒะตัะบะฐ ััะฐัััะฐ
echo "โ ะัะพะฒะตัะบะฐ ััะฐัััะฐ ะบะพะฝัะตะนะฝะตัะพะฒ..."
docker-compose ps

# ะัะพะฒะตัะบะฐ ะปะพะณะพะฒ
echo "๐ ะะพัะปะตะดะฝะธะต ะปะพะณะธ ะฟัะธะปะพะถะตะฝะธั:"
docker-compose logs --tail=20 backend

# ะัะพะฒะตัะบะฐ health check
echo "๐ ะัะพะฒะตัะบะฐ ัะฐะฑะพัะพัะฟะพัะพะฑะฝะพััะธ..."
if curl -f -s http://localhost/health >/dev/null; then
    echo "๐ ะัะธะปะพะถะตะฝะธะต ััะฟะตัะฝะพ ะทะฐะฟััะตะฝะพ!"
    echo "๐ ะกะฐะนั ะดะพัััะฟะตะฝ ะฟะพ ะฐะดัะตัั: http://your-domain.com"
    echo "๐ฑ Telegram: https://t.me/obscur_clothes"
else
    echo "โ๏ธ  ะัะธะปะพะถะตะฝะธะต ะทะฐะฟััะบะฐะตััั... ะัะพะฒะตัััะต ะปะพะณะธ:"
    echo "docker-compose logs backend"
fi

echo "๐ ะะปั ะฟัะพัะผะพััะฐ ะปะพะณะพะฒ: docker-compose logs -f"
echo "๐ ะะปั ะพััะฐะฝะพะฒะบะธ: docker-compose down"